<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber Pro Ultimate - CLOUD ERP</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1e1e2d; --accent: #00a3ff; --gold: #d4af37; --bg: #f4f6f9; --danger: #e74c3c; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; }
        .overlay { position: fixed; inset: 0; background: var(--primary); z-index: 10000; display: flex; justify-content: center; align-items: center; color: white; }
        .box { background: #2b2b40; padding: 40px; border-radius: 20px; width: 400px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #1e1e2d; color: white; }
        .sidebar { width: 260px; background: var(--primary); color: #a2a3b7; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: #1b1b28; color: white; border-left: 4px solid var(--accent); }
        .main { margin-left: 260px; padding: 25px; width: calc(100% - 260px); }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .pos-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .schedule-list { max-height: 300px; overflow-y: auto; }
        .booking-row { display: flex; justify-content: space-between; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .booking-row.active { border-color: var(--accent); background: #eef9ff; border-width: 2px; }
        .services-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .service-btn { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-blue { background: var(--accent); color: white; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        @media print { body * { visibility: hidden; } #printReceipt, #printReceipt * { visibility: visible; } #printReceipt { position: absolute; left: 0; top: 0; display: block !important; width: 80mm; } }
    </style>
</head>
<body>

    <div id="pinScreen" class="overlay">
        <div class="box">
            <i class="fas fa-user-shield" style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"></i>
            <h2>ОПЕРАТОРСКИ ДОСТЪП</h2>
            <input type="password" id="pinInput" maxlength="4" placeholder="****" style="text-align: center; font-size: 24px; letter-spacing: 10px;">
            <button class="btn btn-blue" onclick="window.login()">ВХОД</button>
        </div>
    </div>

    <aside class="sidebar">
        <div style="padding:30px; font-size:24px; color:white; font-weight:bold;">BARBER<span style="color:var(--gold)">PRO</span></div>
        <div class="nav-item active" onclick="showTab('tab-pos')"><i class="fas fa-cash-register"></i> Резервации / POS</div>
        <div id="adminMenu" class="hidden">
            <div class="nav-item" onclick="showTab('tab-add-booking')"><i class="fas fa-calendar-plus"></i> Нова Резервация</div>
            <div class="nav-item" onclick="showTab('tab-stats')"><i class="fas fa-chart-line"></i> Общи отчети</div>
            <div class="nav-item" onclick="showTab('tab-staff')"><i class="fas fa-users-cog"></i> Екип</div>
            <div class="nav-item" onclick="showTab('tab-services')"><i class="fas fa-cut"></i> Услуги</div>
        </div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger);" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Изход</div>
    </aside>

    <main class="main">
        <div id="tab-pos" class="tab-content">
            <div class="pos-grid">
                <div>
                    <div class="card">
                        <h3><i class="fas fa-calendar-day"></i> График</h3>
                        <div id="scheduleList" class="schedule-list"></div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-plus-circle"></i> Бързи услуги</h3>
                        <div id="servicesGrid" class="services-container"></div>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Сметка</h3>
                    <div id="activeInfo" style="margin:10px 0; padding:10px; background:#fff9e6; border-radius:8px; display:none;">
                        Резервация: <strong id="infoCode"></strong> | Клиент: <strong id="infoClient"></strong>
                    </div>
                    <div id="billItems" style="min-height:200px; border-bottom:1px solid #eee;"></div>
                    <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:800; margin:20px 0;">
                        <span>ОБЩО:</span> <span id="totalPrice">0.00</span> лв.
                    </div>
                    <button class="btn btn-blue" onclick="window.finalizePayment()">ФИНАЛИЗИРАЙ</button>
                </div>
            </div>
        </div>

        <div id="tab-add-booking" class="tab-content hidden">
            <div class="card" style="max-width:500px; margin:auto;">
                <h2>Нова Резервация</h2>
                <input type="text" id="bookClient" placeholder="Име на клиент">
                <input type="time" id="bookTime">
                <select id="bookService"></select>
                <button class="btn btn-blue" onclick="window.manualAddBooking()">ЗАПАЗИ</button>
            </div>
        </div>

        <div id="tab-stats" class="tab-content hidden">
            <div class="card"><h2>Облачен Отчет</h2><div id="statsTableContainer"></div></div>
        </div>
        
        <div id="tab-staff" class="tab-content hidden">
            <div class="card">
                <h3>Екип</h3>
                <div style="display:flex; gap:10px;"><input type="text" id="sName" placeholder="Име"><input type="text" id="sPin" placeholder="ПИН"><button onclick="window.addStaff()">ДОБАВИ</button></div>
                <table id="staffTable"><thead><tr><th>Име</th><th>ПИН</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="tab-services" class="tab-content hidden">
            <div class="card">
                <h3>Услуги</h3>
                <div style="display:flex; gap:10px;"><input type="text" id="svName" placeholder="Услуга"><input type="number" id="svPrice" placeholder="Цена"><button onclick="window.addSvc()">ДОБАВИ</button></div>
                <table id="servicesTable"><thead><tr><th>Име</th><th>Цена</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </main>

    <div id="printReceipt" style="display:none; font-family:monospace; padding:20px;">
        <center><h2>BARBER PRO</h2><p id="rDate"></p></center>
        <hr><div id="rItems"></div><hr>
        <div style="display:flex; justify-content:space-between;"><b>ОБЩО:</b><b id="rTotal"></b></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCo4eLTJZIsocuxe5Jpp4HlJV9QCrdfO8I",
            authDomain: "barberpro-49b26.firebaseapp.com",
            projectId: "barberpro-49b26",
            storageBucket: "barberpro-49b26.firebasestorage.app",
            messagingSenderId: "390589993920",
            appId: "1:390589993920:web:6c5393d1ebba06222c6e25"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let currentBill = [];
        let activeBooking = null;

        // Първоначално зареждане на данни от LocalStorage за настройките, но продажбите отиват в Cloud
        let localData = JSON.parse(localStorage.getItem('barber_v3_db')) || {
            staff: [{name: "Админ", pin: "0000", role: "admin"}],
            services: [{name: "Подстригване", price: 20}, {name: "Брада", price: 10}],
            bookings: []
        };

        window.login = () => {
            let pin = document.getElementById('pinInput').value;
            let user = localData.staff.find(u => u.pin === pin);
            if(user) {
                currentUser = user;
                document.getElementById('pinScreen').classList.add('hidden');
                if(user.role === 'admin') document.getElementById('adminMenu').classList.remove('hidden');
                init();
            } else alert("Грешен ПИН!");
        };

        function init() {
            renderServices();
            renderSchedule();
            updateDropdown();
        }

        window.addService = (name, price) => {
            currentBill.push({name, price});
            updateUI();
        };

        function updateUI() {
            const container = document.getElementById('billItems');
            let total = 0;
            container.innerHTML = currentBill.map((item, i) => {
                total += item.price;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${item.name}</span><span>${item.price.toFixed(2)} лв. <i class="fas fa-trash" onclick="removeItem(${i})" style="color:red; cursor:pointer"></i></span></div>`;
            }).join('');
            document.getElementById('totalPrice').innerText = total.toFixed(2);
        }

        window.removeItem = (i) => { currentBill.splice(i, 1); updateUI(); };

        window.finalizePayment = async () => {
            if(!currentBill.length) return;
            let total = parseFloat(document.getElementById('totalPrice').innerText);
            
            // Запис в ОБЛАКА
            await addDoc(collection(db, "sales"), {
                operator: currentUser.name,
                items: currentBill,
                total: total,
                timestamp: serverTimestamp()
            });

            // Ако е било от резервация - махаме я
            if(activeBooking) {
                localData.bookings = localData.bookings.filter(b => b.code !== activeBooking.code);
                saveLocal();
            }

            alert("Продажбата е записана успешно!");
            currentBill = [];
            activeBooking = null;
            document.getElementById('activeInfo').style.display = 'none';
            updateUI();
            renderSchedule();
        };

        window.manualAddBooking = () => {
            const client = document.getElementById('bookClient').value;
            const time = document.getElementById('bookTime').value;
            const svc = localData.services.find(s => s.name === document.getElementById('bookService').value);
            if(!client || !time) return;
            
            localData.bookings.push({ code: "B"+Date.now().toString().slice(-3), client, time, svc: svc.name, price: svc.price });
            saveLocal();
            renderSchedule();
            window.showTab('tab-pos');
        };

        function renderSchedule() {
            const list = document.getElementById('scheduleList');
            localData.bookings.sort((a,b) => a.time.localeCompare(b.time));
            list.innerHTML = localData.bookings.map(b => `
                <div class="booking-row" onclick="window.loadBooking('${b.code}')">
                    <span><b>${b.time}</b> - ${b.client}</span><span>${b.svc}</span>
                </div>
            `).join('') || "Няма резервации";
        }

        window.loadBooking = (code) => {
            let b = localData.bookings.find(x => x.code === code);
            activeBooking = b;
            document.getElementById('activeInfo').style.display = 'block';
            document.getElementById('infoCode').innerText = b.code;
            document.getElementById('infoClient').innerText = b.client;
            currentBill = [{name: b.svc, price: b.price}];
            updateUI();
        };

        function renderServices() {
            document.getElementById('servicesGrid').innerHTML = localData.services.map(s => `
                <div class="service-btn" onclick="window.addService('${s.name}', ${s.price})">${s.name}<br>${s.price} лв.</div>
            `).join('');
        }

        function updateDropdown() {
            document.getElementById('bookService').innerHTML = localData.services.map(s => `<option>${s.name}</option>`).join('');
        }

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'tab-staff') renderStaff();
            if(id === 'tab-services') renderAdminServices();
        };

        function saveLocal() { localStorage.setItem('barber_v3_db', JSON.stringify(localData)); }

        // Облачен отчет - виждаш го в реално време
        onSnapshot(query(collection(db, "sales"), orderBy("timestamp", "desc")), (snap) => {
            let html = '<table><tr><th>Час</th><th>Оператор</th><th>Сума</th></tr>';
            snap.forEach(doc => {
                let s = doc.data();
                let t = s.timestamp ? new Date(s.timestamp.seconds*1000).toLocaleTimeString() : '...';
                html += `<tr><td>${t}</td><td>${s.operator}</td><td>${s.total.toFixed(2)} лв.</td></tr>`;
            });
            document.getElementById('statsTableContainer').innerHTML = html + "</table>";
        });

        // Админ функции
        window.addStaff = () => { localData.staff.push({name: document.getElementById('sName').value, pin: document.getElementById('sPin').value, role:'operator'}); saveLocal(); renderStaff(); };
        function renderStaff() { document.querySelector('#staffTable tbody').innerHTML = localData.staff.map(s => `<tr><td>${s.name}</td><td>${s.pin}</td></tr>`).join(''); }
        window.addSvc = () => { localData.services.push({name: document.getElementById('svName').value, price: parseFloat(document.getElementById('svPrice').value)}); saveLocal(); renderAdminServices(); renderServices(); updateDropdown(); };
        function renderAdminServices() { document.querySelector('#servicesTable tbody').innerHTML = localData.services.map(s => `<tr><td>${s.name}</td><td>${s.price} лв.</td></tr>`).join(''); }

    </script>
</body>
</html>